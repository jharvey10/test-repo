name: Enrich Release Notes with Contributors

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  enrich-release:
    runs-on: ubuntu-latest
    steps:
      - name: Generate token üîê
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Enrich release notes with contributors üôã
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const release = context.payload.release;
            const releaseBody = release.body || '';
            const lines = releaseBody.split('\n');
            let newReleaseBody = releaseBody;

            for (const line of lines) {
              const prMatch = line.match(/\[#(\d+)\]\([^)]+\)/);
              if (!prMatch) continue;

              const prNumber = Number.parseInt(prMatch[1], 10);
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              const username = pr.user.login;

              console.log(`PR #${prNumber} authored by @${username}`);
              newReleaseBody = newReleaseBody.replace(line, `${line} (@${username})`);
            }

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: newReleaseBody
            });

            console.log('Release notes updated successfully with contributor information');
